<html>
  <head>
    <title>8th Light - Code Challenge</title>
  </head>
  <body>

    <form id="searchBooksForm">
      <input type="text" id="query" placeholder="Search Books">
      <button id="searchButton" type="submit" name="button">Search</button>
    </form>

    <div id="heading"></div>

    <div id="content"></div>

    <div class="readingListWrapper">
      <button type="button" name="displayList" id ="readingListButton">Show Reading List</button>
      <div class="readingList">

      </div>
    </div>

    <script>
    let readingList = [];
    document.getElementById("searchBooksForm").addEventListener('submit', e => {
        loadBooks();
        // Prevent the default form submit
        e.preventDefault();
    });

    document.getElementById("readingListButton").addEventListener('click', e => {
      showReadingList(readingList);
    })



    function loadBooks() {
      //Loading the books using an async call

      let query = document.getElementById("query").value;
      document.getElementById("query").value = "";
      // Appending query to the url of the api to mimic a GET function

      //A bit of string sanitization and formatting for the request
      //The only special character not allowed is the plus (+) sign which would confuse the query
      query = query.trim();
      query = query.replace("+", "")
      query = query.replace(" ", "+");

      const baseURL = "https://www.googleapis.com/books/v1/volumes?q="+query;

      const xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {

         let info =(JSON.parse(this.responseText));
         getNItems(info, 5);
         addBookToList(info);

       } else if(this.readyState == 4 && this.status != 200){
           console.log("There has been an error with the http request, try checking the values you submitted on the form");
           console.log(JSON.parse(this.responseText));
          }
        };
      xhr.open("GET", baseURL, true);
      xhr.send();
    }

    function getNItems(jsonBooks, num){
      document.getElementById('heading').innerHTML = "";
      document.getElementById("content").innerHTML = "";
      //Print the first 5 query items
      if (jsonBooks.totalItems != 0){
        document.getElementById('heading').innerHTML =
          "<h3>Select entry number to add book to your reading list:</h3>";

        const listLength = jsonBooks.items.length;
          for (let i = 0; i < listLength; i++) {
            if(i == num){break};
            printBookInfo(jsonBooks.items[i], i);
            };

      }else{
        document.getElementById('heading').innerHTML =
          "<h3>The query matched no books</h3>";
        };
      }

    function printBookInfo(book, i){
      //Format how book items are displayed for user
      const authors = book.volumeInfo.authors;
      const title = book.volumeInfo.title;
      const publisher = book.volumeInfo.publisher;

      document.getElementById("content").innerHTML +=
                "<div class = 'entry' id='" + (i+1) +"'>" +
                "<h3>Entry " + (i+1) + "</h3>";
      if (authors != undefined){
        for(let j=0; j < authors.length; j++){
          document.getElementsByClassName("entry")[i].innerHTML +=
            "<li><b>Author:</b> "+ authors[j]+ "</li>";
        }
      }else{
        document.getElementsByClassName("entry")[i].innerHTML +=
          "<li><b>Author:</b> None </li>";
        }
      document.getElementsByClassName("entry")[i].innerHTML +=
        "<li><b>Title:</b> " + title + "</li>" +
        "<li><b>Publisher:</b> " + publisher + "</li>" +
        "</ul></div>";

    };

    function addBookToList(jsonBooks){
      const buttons = document.querySelectorAll("div.entry")
        for (const button of buttons) {
          button.addEventListener('click', function() {
            const elementNumber = (this.id -1);
            readingList.unshift(jsonBooks.items[elementNumber]);
            document.getElementById("heading").innerHTML = "<h3>" + jsonBooks.items[elementNumber].volumeInfo.title + " Was added to reading list </h3>";
          })
        }
    }

    function showReadingList(list){
      document.getElementById('heading').innerHTML = "<h3>Here is Your Current Reading List</h3>";
      document.getElementById("content").innerHTML = "";
      for (let i = 0; i < list.length; i++){
        printBookInfo(list[i], i);
      }
    }


    </script>
    <style media="screen">
      div.entry{
        margin-top: 20px;
        background-color: lightgrey;
        padding: 20px;
      }
      .entry> h3{
        margin-top: 0;
      }
      div.entry:hover{
        cursor: pointer;
        transform: scale(1.01);
      }
      div.readingListWrapper{
        margin-top: 30px;
      }

    </style>
  </body>
</html>
